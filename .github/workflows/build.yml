name: Rooted Android Emulator with Web Access

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  rooted_emulator:
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools: 'latest'
        build-tools: '34.0.0'
        platform-tools: 'latest'
        platforms: 'android-30'
        emulator: 'latest'
        ndk: 'none'

    - name: Install ARM64 system image
      run: |
        sdkmanager --install "system-images;android-30;google_apis;arm64-v8a"
        echo "arm64 system image installed"

    - name: Configure and start emulator
      run: |
        # Create AVD
        echo "no" | avdmanager create avd \
          --force \
          --name test \
          --package "system-images;android-30;google_apis;arm64-v8a" \
          --abi "arm64-v8a" \
          --device "Nexus 5X"
        
        # Modify AVD config
        echo "hw.cpu.ncore=2" >> ~/.android/avd/test.avd/config.ini
        echo "hw.gpu.enabled=no" >> ~/.android/avd/test.avd/config.ini
        echo "hw.gpu.mode=swiftshader_indirect" >> ~/.android/avd/test.avd/config.ini
        echo "vm.heapSize=256" >> ~/.android/avd/test.avd/config.ini
        
        # Start emulator with full software rendering
        nohup $ANDROID_SDK_ROOT/emulator/emulator \
          -avd test \
          -port 5554 \
          -no-window \
          -no-snapshot \
          -no-audio \
          -no-boot-anim \
          -gpu swiftshader_indirect \
          -accel off \
          -qemu -machine virt,accel=tcg,tb-size=128 \
          -memory 2048 \
          -partition-size 2048 \
          -writable-system \
          > /dev/null 2>&1 &
        
        # Wait for emulator to start
        adb wait-for-device
        echo "Emulator started successfully"

    - name: Root the emulator
      run: |
        adb root
        adb remount
        adb shell avbctl disable-verification
        adb reboot
        adb wait-for-device
        adb root
        adb remount
        echo "Emulator rooted successfully"

    - name: Install required packages
      run: |
        brew install scrcpy websockify novnc

    - name: Setup web access
      run: |
        adb forward tcp:8888 localabstract:scrcpy
        websockify --web /usr/local/share/novnc 6080 localhost:8888 &
        echo "Web interface available at: http://localhost:6080/vnc.html"
        sleep 1800
